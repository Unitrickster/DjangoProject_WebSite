{% extends 'base.html' %}
{% load static %}

{% block title %}{{ client.full_name }} - –ê–†–ú KIA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{% url 'sales:client_list' %}" class="btn btn-outline-secondary me-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="mb-0"><i class="fas fa-user me-2"></i>{{ client.full_name }}</h1>
    </div>
    <div class="btn-group">
        <a href="tel:{{ client.phone }}" class="btn btn-success">
            <i class="fas fa-phone me-1"></i>–ü–æ–∑–≤–æ–Ω–∏—Ç—å
        </a>
        <a href="https://wa.me/{{ client.phone }}" class="btn btn-success" target="_blank">
            <i class="fab fa-whatsapp me-1"></i>WhatsApp
        </a>
        {% if client.email %}
        <a href="mailto:{{ client.email }}" class="btn btn-primary">
            <i class="fas fa-envelope me-1"></i>Email
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="col-md-4">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 80px; height: 80px;">
                        <span class="text-white fw-bold" style="font-size: 2rem;">{{ client.full_name|first|upper }}</span>
                    </div>
                    <h4>{{ client.full_name }}</h4>
                    <span class="badge bg-{% if client.source == 'website' %}primary{% elif client.source == 'phone' %}success{% elif client.source == 'showroom' %}warning{% else %}info{% endif %}">
                        {{ client.get_source_display }}
                    </span>
                </div>

                <div class="client-info">
                    <div class="info-item mb-3">
                        <label class="form-label text-muted mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ client.phone }}</span>
                            <a href="tel:{{ client.phone }}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-phone"></i>
                            </a>
                        </div>
                    </div>

                    {% if client.email %}
                    <div class="info-item mb-3">
                        <label class="form-label text-muted mb-1">Email</label>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ client.email }}</span>
                            <a href="mailto:{{ client.email }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-envelope"></i>
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    {% if client.passport_series %}
                    <div class="info-item mb-3">
                        <label class="form-label text-muted mb-1">–ü–∞—Å–ø–æ—Ä—Ç</label>
                        <p class="mb-0 fw-bold">{{ client.passport_series }} {{ client.passport_number }}</p>
                        {% if client.passport_issued_by %}
                        <small class="text-muted">{{ client.passport_issued_by }}</small>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if client.registration_address %}
                    <div class="info-item mb-3">
                        <label class="form-label text-muted mb-1">–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                        <p class="mb-0">{{ client.registration_address }}</p>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <label class="form-label text-muted mb-1">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                        <p class="mb-0">{{ client.created_at|date:"d.m.Y H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addInteractionModal">
                        <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
                    </button>
                    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#createLeadModal">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                    <a href="#" class="btn btn-outline-warning">
                        <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </a>
                    <a href="#" class="btn btn-outline-info">
                        <i class="fas fa-file-contract me-2"></i>–°–æ–∑–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
    <div class="col-md-8">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="card-title text-muted mb-1">–ó–∞—è–≤–∫–∏</h6>
                        <h3 class="text-primary mb-0">{{ leads.count }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="card-title text-muted mb-1">–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è</h6>
                        <h3 class="text-success mb-0">{{ interactions.count }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="card-title text-muted mb-1">–ü–æ–∫—É–ø–∫–∏</h6>
                        <h3 class="text-warning mb-0">{{ contracts.count }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="card-title text-muted mb-1">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h6>
                        <h3 class="text-info mb-0">85%</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">–ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addInteractionModal">
                    <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
            <div class="card-body">
                {% if interactions %}
                <div class="timeline">
                    {% for interaction in interactions %}
                    <div class="timeline-item {% if forloop.first %}first{% endif %}">
                        <div class="timeline-marker 
                            {% if interaction.type == 'call' %}bg-success
                            {% elif interaction.type == 'email' %}bg-primary
                            {% elif interaction.type == 'meeting' %}bg-warning
                            {% elif interaction.type == 'test_drive' %}bg-info
                            {% else %}bg-secondary{% endif %}">
                            <i class="fas 
                                {% if interaction.type == 'call' %}fa-phone
                                {% elif interaction.type == 'email' %}fa-envelope
                                {% elif interaction.type == 'meeting' %}fa-handshake
                                {% elif interaction.type == 'test_drive' %}fa-car
                                {% else %}fa-sticky-note{% endif %} text-white">
                            </i>
                        </div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0">{{ interaction.get_type_display }}</h6>
                                <small class="text-muted">{{ interaction.date_time|date:"d.m.Y H:i" }}</small>
                            </div>
                            <p class="mb-2">{{ interaction.result }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>{{ interaction.manager.get_full_name|default:interaction.manager.username }}
                                </small>
                                {% if interaction.next_contact_date %}
                                <small class="text-warning">
                                    <i class="fas fa-clock me-1"></i>–°–ª–µ–¥. –∫–æ–Ω—Ç–∞–∫—Ç: {{ interaction.next_contact_date|date:"d.m.Y H:i" }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">–ù–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π</h5>
                    <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInteractionModal">
                        <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ó–∞—è–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ó–∞—è–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞</h5>
            </div>
            <div class="card-body">
                {% if leads %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in leads %}
                            <tr>
                                <td class="fw-bold">#{{ lead.id }}</td>
                                <td>
                                    <span class="badge 
                                        {% if lead.status == 'new' %}bg-warning
                                        {% elif lead.status == 'in_progress' %}bg-info
                                        {% elif lead.status == 'presentation' %}bg-primary
                                        {% elif lead.status == 'test_drive' %}bg-secondary
                                        {% elif lead.status == 'contract' %}bg-dark
                                        {% elif lead.status == 'success' %}bg-success
                                        {% elif lead.status == 'failed' %}bg-danger
                                        {% endif %}">
                                        {{ lead.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ lead.assigned_manager.get_full_name|default:lead.assigned_manager.username }}</td>
                                <td>{{ lead.created_date|date:"d.m.Y" }}</td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-muted mb-3">–£ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLeadModal">
                        <i class="fas fa-plus me-1"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è -->
<div class="modal fade" id="addInteractionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è</label>
                        {{ form.type }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                        {{ form.date_time }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
                        {{ form.result }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</label>
                        {{ form.next_contact_date }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
<div class="modal fade" id="createLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –¥–ª—è {{ client.full_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createLeadForm">
                    <div class="mb-3">
                        <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞—è–≤–∫–∏</label>
                        <select class="form-select" name="source">
                            <option value="website">üåê –°–∞–π—Ç</option>
                            <option value="phone">üìû –¢–µ–ª–µ—Ñ–æ–Ω</option>
                            <option value="showroom">üè¢ –®–æ—É-—Ä—É–º</option>
                            <option value="recommendation">üë• –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea class="form-control" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select class="form-select" name="priority">
                            <option value="3">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                            <option value="2" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="1">üü¢ –ù–∏–∑–∫–∏–π</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveLead">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
    document.getElementById('saveLead').addEventListener('click', function() {
        const form = document.getElementById('createLeadForm');
        const formData = new FormData(form);
        
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
        console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏:', Object.fromEntries(formData));
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(document.getElementById('createLeadModal'));
        modal.hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        alert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
    });
});
</script>

<style>
.avatar-lg {
    font-size: 2rem;
}
.client-info .info-item {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 1rem;
}
.client-info .info-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}
.timeline {
    position: relative;
    padding-left: 2rem;
}
.timeline-item {
    position: relative;
    padding-bottom: 2rem;
}
.timeline-item.first {
    padding-top: 0;
}
.timeline-marker {
    position: absolute;
    left: -2rem;
    top: 0;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 3px solid #e9ecef;
}
.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -0.75rem;
    top: 2.5rem;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}
</style>
{% endblock %}