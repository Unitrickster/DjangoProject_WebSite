{% extends 'base.html' %}
{% load static %}

{% block title %}–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ - –ê–†–ú KIA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-list me-2"></i>–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫</h1>
    <div class="d-flex gap-2">
        <a href="{% url 'sales:lead_kanban' %}" class="btn btn-outline-primary">
            <i class="fas fa-columns me-1"></i>–ö–∞–Ω–±–∞–Ω
        </a>
        <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" placeholder="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞..." id="searchInput">
            <button class="btn btn-outline-secondary" type="button" id="searchButton">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="statusFilter">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="new">üÜï –ù–æ–≤–∞—è</option>
                    <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="presentation">üìä –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</option>
                    <option value="test_drive">üöó –¢–µ—Å—Ç-–¥—Ä–∞–π–≤</option>
                    <option value="contract">üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</option>
                    <option value="success">‚úÖ –£—Å–ø–µ—Ö</option>
                    <option value="failed">‚ùå –ü—Ä–æ–≤–∞–ª</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select class="form-select" id="priorityFilter">
                    <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                    <option value="3">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                    <option value="2">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="1">üü¢ –ù–∏–∑–∫–∏–π</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                <select class="form-select" id="sourceFilter">
                    <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                    <option value="website">üåê –°–∞–π—Ç</option>
                    <option value="phone">üìû –¢–µ–ª–µ—Ñ–æ–Ω</option>
                    <option value="showroom">üè¢ –®–æ—É-—Ä—É–º</option>
                    <option value="recommendation">üë• –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" id="resetFilters">
                    <i class="fas fa-undo me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-white bg-primary">
            <div class="card-body text-center p-3">
                <h6 class="card-title">–í—Å–µ–≥–æ</h6>
                <h4 class="mb-0">{{ leads.count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-warning">
            <div class="card-body text-center p-3">
                <h6 class="card-title">–ù–æ–≤—ã–µ</h6>
                <h4 class="mb-0">{{ leads|length }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-info">
            <div class="card-body text-center p-3">
                <h6 class="card-title">–í —Ä–∞–±–æ—Ç–µ</h6>
                <h4 class="mb-0">{{ leads|length }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-success">
            <div class="card-body text-center p-3">
                <h6 class="card-title">–£—Å–ø–µ—Ö</h6>
                <h4 class="mb-0">{{ leads|length }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-danger">
            <div class="card-body text-center p-3">
                <h6 class="card-title">–ü—Ä–æ–≤–∞–ª</h6>
                <h4 class="mb-0">{{ leads|length }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-secondary">
            <div class="card-body text-center p-3">
                <h6 class="card-title">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</h6>
                <h4 class="mb-0">25%</h4>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">–ó–∞—è–≤–∫–∏</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" id="leadsTable">
                <thead class="table-light">
                    <tr>
                        <th width="50">ID</th>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                        <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th width="120">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in leads %}
                    <tr class="lead-row" data-status="{{ lead.status }}" data-priority="{{ lead.priority }}" data-source="{{ lead.source }}">
                        <td class="fw-bold">#{{ lead.id }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <span class="text-white fw-bold">{{ lead.client.full_name|first|upper }}</span>
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ lead.client.full_name }}</h6>
                                    <small class="text-muted">{{ lead.initial_comment|truncatechars:30 }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>
                                <div><i class="fas fa-phone text-muted me-1"></i> {{ lead.client.phone }}</div>
                                {% if lead.client.email %}
                                <div><i class="fas fa-envelope text-muted me-1"></i> {{ lead.client.email }}</div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge 
                                {% if lead.status == 'new' %}bg-warning
                                {% elif lead.status == 'in_progress' %}bg-info
                                {% elif lead.status == 'presentation' %}bg-primary
                                {% elif lead.status == 'test_drive' %}bg-secondary
                                {% elif lead.status == 'contract' %}bg-dark
                                {% elif lead.status == 'success' %}bg-success
                                {% elif lead.status == 'failed' %}bg-danger
                                {% endif %}">
                                {{ lead.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if lead.priority == 3 %}bg-danger
                                {% elif lead.priority == 2 %}bg-warning
                                {% else %}bg-success
                                {% endif %}">
                                {{ lead.get_priority_display }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">
                                {{ lead.get_source_display }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                                    <span class="text-white fw-bold small">{{ lead.assigned_manager.username|first|upper }}</span>
                                </div>
                                {{ lead.assigned_manager.get_full_name|default:lead.assigned_manager.username }}
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">{{ lead.created_date|date:"d.m.Y H:i" }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'sales:client_detail' lead.client.pk %}" class="btn btn-outline-primary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-outline-secondary" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å" data-bs-toggle="modal" data-bs-target="#statusModal" data-lead-id="{{ lead.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="tel:{{ lead.client.phone }}" class="btn btn-outline-success" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
                                    <i class="fas fa-phone"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫</h5>
                            <p class="text-muted">–ó–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="leadId" name="lead_id">
                    <div class="mb-3">
                        <label class="form-label">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="newStatus" name="new_status">
                            <option value="new">üÜï –ù–æ–≤–∞—è</option>
                            <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="presentation">üìä –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</option>
                            <option value="test_drive">üöó –¢–µ—Å—Ç-–¥—Ä–∞–π–≤</option>
                            <option value="contract">üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</option>
                            <option value="success">‚úÖ –£—Å–ø–µ—Ö</option>
                            <option value="failed">‚ùå –ü—Ä–æ–≤–∞–ª</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea class="form-control" id="statusComment" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveStatus">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const sourceFilter = document.getElementById('sourceFilter');
    const searchInput = document.getElementById('searchInput');
    const resetButton = document.getElementById('resetFilters');
    const leadsTable = document.getElementById('leadsTable');
    const leadRows = leadsTable.querySelectorAll('.lead-row');

    function filterLeads() {
        const statusValue = statusFilter.value;
        const priorityValue = priorityFilter.value;
        const sourceValue = sourceFilter.value;
        const searchValue = searchInput.value.toLowerCase();

        leadRows.forEach(row => {
            const statusMatch = !statusValue || row.dataset.status === statusValue;
            const priorityMatch = !priorityValue || row.dataset.priority === priorityValue;
            const sourceMatch = !sourceValue || row.dataset.source === sourceValue;
            const textMatch = !searchValue || row.textContent.toLowerCase().includes(searchValue);

            row.style.display = (statusMatch && priorityMatch && sourceMatch && textMatch) ? '' : 'none';
        });
    }

    statusFilter.addEventListener('change', filterLeads);
    priorityFilter.addEventListener('change', filterLeads);
    sourceFilter.addEventListener('change', filterLeads);
    searchInput.addEventListener('input', filterLeads);

    resetButton.addEventListener('click', function() {
        statusFilter.value = '';
        priorityFilter.value = '';
        sourceFilter.value = '';
        searchInput.value = '';
        filterLeads();
    });

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    const statusModal = document.getElementById('statusModal');
    statusModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const leadId = button.getAttribute('data-lead-id');
        document.getElementById('leadId').value = leadId;
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    document.getElementById('saveStatus').addEventListener('click', function() {
        const leadId = document.getElementById('leadId').value;
        const newStatus = document.getElementById('newStatus').value;
        const comment = document.getElementById('statusComment').value;

        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:', { leadId, newStatus, comment });
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(statusModal);
        modal.hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        alert('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
    });

    // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
    document.getElementById('searchButton').addEventListener('click', filterLeads);
});
</script>

<style>
.avatar-sm {
    font-size: 0.8rem;
}
.lead-row:hover {
    background-color: #f8f9fa !important;
}
.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}
.card {
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
}
</style>
{% endblock %}